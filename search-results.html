<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Search Results - PRATA</title>
        <!-- CSS Includes -->
        <!-- <link rel="stylesheet" href="globals.css"> -->
        <link rel="stylesheet" href="css/common.css">
        <link rel="stylesheet" href="css/search-results.css"> <!-- Specific styles -->
        <link rel="stylesheet" href="css/index.css"> <!-- Reuse card styles from index -->

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
         <style>
            /* Basic style to hide no-results message initially */
            #no-results-message { display: none; text-align: center; padding: 2rem; color: #555; }
        </style>
    </head>
<body>

    <!-- Reusing Header -->
    <header class="main-header">
        <div class="container">
            <a href="index.html" class="header-logo">
                <img src="images/PRATA logo.png" alt="PRATA Logo">
            </a>
            <nav class="header-nav">
                 <!-- Use consistent icons/links from index.html if desired -->
                <a href="wishlist.html" class="nav-link wishlist-link" aria-label="Wishlist">
                    <i class="fa-regular fa-heart"></i>
                    <span class="nav-text">Wishlist</span>
                    <span class="wishlist-count-badge" style="display: none;">0</span>
                </a>
                 <a href="profile.html" class="nav-link profile-link" aria-label="Profile Menu">
                    <i class="fa-regular fa-user-circle"></i>
                    <span class="nav-text">Profile</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="search-results-header">
            <h1 class="section-title alt-title">Search Results</h1>
            <p id="search-criteria">Loading search results...</p> <!-- Updated by JS -->
        </div>

        <!-- Results Grid - Populated by JS -->
        <div class="rental-cards-grid" id="results-grid">
            <!-- Property cards will be inserted here -->
        </div>

        <!-- No Results Message - Shown by JS if needed -->
        <p id="no-results-message">No properties found matching your criteria. Try adjusting your search on the <a href="index.html">homepage</a>.</p>

    </main>

    <!-- Reusing Footer -->
    <footer class="main-footer">
       <div class="container">
           <!-- Copy footer content from index.html -->
           <div class="footer-grid">
                <div class="footer-col footer-about">
                    <img src="images/PRATA logo.png" alt="PRATA Footer Logo" class="footer-logo">
                    <p>Your trusted platform for finding rental properties in Nepal. Simple, secure, and efficient.</p>
                </div>
                <div class="footer-col footer-links">
                    <h4>Quick Links</h4>
                     <ul>
                        <li><a href="allproperties.html">All Properties</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="become-host.html">List Your Property</a></li>
                         <li><a href="contact.html">Contact Us</a></li>
                         <li><a href="help.html">Help Center</a></li>
                    </ul>
                </div>
                 <div class="footer-col footer-legal">
                    <h4>Legal</h4>
                    <ul>
                        <li><a href="terms.html">Terms of Service</a></li>
                        <li><a href="privacy.html">Privacy Policy</a>
                        <li><a href="cancellation.html">Cancellation Policy</a></li>
                    </ul>
                </div>
                <div class="footer-col footer-social">
                    <h4>Follow Us</h4>
                     <div class="social-icons">
                         <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                         <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                         <a href="#" target="_blank" rel="noopener noreferrer" aria-label="Twitter"><i class="fab fa-twitter"></i></a>
                     </div>
                </div>
            </div>
           <div class="footer-copyright">
               Â© 2024 PRATA Rentals. All rights reserved. Designed with <i class="fa-regular fa-heart" style="color: #e48a8a;"></i> for Nepal.
           </div>
       </div>
    </footer>

    <!-- General script if it contains shared functions like formatCurrency -->
    <script src="js/script.js"></script>

    <!-- Dynamic Search Results Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const locationQuery = params.get('location')?.trim().toLowerCase() || ''; // Get location, trim, lowercase
            const categoryQuery = params.get('category') || ''; // Get category exactly
            const maxPriceQuery = params.get('max_price'); // Get max price as string

            const criteriaP = document.getElementById('search-criteria');
            const resultsGrid = document.getElementById('results-grid');
            const noResultsMsg = document.getElementById('no-results-message');

            // --- Update Search Criteria Display ---
            let criteriaText = 'Showing results for: ';
            let conditions = [];
            if (locationQuery) conditions.push(` Location "${params.get('location')}"`); // Use original case for display
            // Display category only if it's NOT 'Room' and not empty
            if (categoryQuery && categoryQuery !== 'Room') conditions.push(` Type "${categoryQuery}"`);
            else if (!categoryQuery) conditions.push(` Any Type (excluding Rooms)`); // Clarify if no type selected
            if (maxPriceQuery) {
                 const priceNum = parseInt(maxPriceQuery, 10);
                 if (!isNaN(priceNum)) {
                    conditions.push(` Max Price NPR ${priceNum.toLocaleString('en-NP')}`);
                 }
            }
            if (conditions.length === 0) {
                criteriaText = 'Showing all available properties (excluding Rooms).';
            } else {
                criteriaText += conditions.join(',');
                // Add clarification that rooms are excluded if no specific type was chosen OR if a non-room type was chosen
                if (!categoryQuery || (categoryQuery && categoryQuery !== 'Room')) {
                     criteriaText += ' (excluding Rooms)';
                }
                 criteriaText += '.';
            }
            if (criteriaP) criteriaP.textContent = criteriaText;


            // --- Fetch and Filter Data ---
            const fetchAndDisplayResults = async () => {
                try {
                    const response = await fetch('properties.json'); // Adjust path if needed
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const properties = await response.json();

                    // --- Filtering Logic ---
                    const filteredProperties = properties.filter(property => {
                        // Condition 1: Exclude 'Room' type
                        if (property.type === 'Room') {
                            return false;
                        }

                        // Condition 2: Match Category (if specified, and not 'Room')
                        if (categoryQuery && categoryQuery !== 'Room' && property.type !== categoryQuery) {
                            return false; // Exclude if category selected and doesn't match
                        }

                        // Condition 3: Match Location (case-insensitive substring)
                        if (locationQuery && !(property.location?.toLowerCase().includes(locationQuery))) {
                            return false; // Exclude if location specified and doesn't match
                        }

                        // Condition 4: Match Max Price
                        if (maxPriceQuery) {
                            const maxPriceNum = parseInt(maxPriceQuery, 10);
                            const propertyPriceNum = parseInt(property.price, 10);
                             // Only filter if maxPrice is a valid number
                            if (!isNaN(maxPriceNum) && !isNaN(propertyPriceNum) && propertyPriceNum > maxPriceNum) {
                                return false; // Exclude if property price exceeds max price
                            }
                        }

                        // If all conditions pass (or weren't applicable), include the property
                        return true;
                    });
                    // --- End Filtering Logic ---


                    // --- Display Results ---
                    resultsGrid.innerHTML = ''; // Clear loading/placeholders
                    noResultsMsg.style.display = 'none'; // Hide initially

                    if (filteredProperties.length === 0) {
                        noResultsMsg.style.display = 'block'; // Show no results message
                    } else {
                        filteredProperties.forEach(property => {
                            const cardElement = createPropertyCard(property); // Use helper function
                            resultsGrid.appendChild(cardElement);
                        });
                    }

                } catch (error) {
                    console.error("Error fetching or displaying search results:", error);
                    resultsGrid.innerHTML = ''; // Clear loading/placeholders
                    criteriaP.textContent = 'Could not load property data. Please try again later.';
                    noResultsMsg.textContent = `An error occurred: ${error.message}`;
                    noResultsMsg.style.display = 'block';
                    noResultsMsg.style.color = 'red';
                }
            };


            // --- Helper Function to Create Property Card HTML ---
            // Uses styles/structure similar to index.html cards
            const createPropertyCard = (property) => {
                const link = document.createElement('a');
                link.href = `property.html?id=${property.id}`;
                link.classList.add('property-card-link'); // Use classes from index.css if reusing
                link.dataset.propertyId = property.id;

                const card = document.createElement('article');
                card.classList.add('property-card'); // Use classes from index.css
                card.dataset.propertyId = property.id;

                // Adapt formatting and features based on your card design
                const priceFormatted = formatCurrency(property.price, property.currency) + (property.priceSuffix || '');

                // Simple feature display (customize as needed)
                let featuresHTML = '';
                if (property.features && property.features.length > 0) {
                    // Take first 2-3 features for card summary
                    featuresHTML = property.features.slice(0, 2).map(f =>
                        `<span><i class="fas ${f.icon || 'fa-check'}"></i> ${f.text || ''}</span>`
                    ).join('');
                }
                 // Add floor/wifi info to summary if relevant and space permits
                 if ((property.type === 'House' || property.type === 'Villa') && property.numberOfFloors) {
                      featuresHTML += `<span><i class="fas fa-layer-group"></i> ${property.numberOfFloors} Floors</span>`;
                 } else if ((property.type === 'Apartment' || property.type === 'Flat') && property.floorNumber) {
                     featuresHTML += `<span><i class="fas fa-building"></i> Floor ${property.floorNumber}</span>`;
                 }
                 // Limit total features shown on card if needed

                card.innerHTML = `
                    <div class="card-image-container">
                        <img src="${property.image || 'images/placeholder.png'}" alt="${property.title || 'Property'}" class="card-image" loading="lazy">
                        ${property.tag ? `<span class="card-tag card-tag-${property.tag.toLowerCase()}">${property.tag}</span>` : ''}
                        <div class="card-price">${priceFormatted}</div>
                        <button class="wishlist-button on-card-wishlist" data-property-id="${property.id}" aria-label="Add to wishlist">
                            <i class="far fa-heart"></i>
                        </button>
                    </div>
                    <div class="card-text-content">
                        <h3 class="card-title">${property.title || 'Untitled Property'}</h3>
                        <p class="card-location"><i class="fas fa-map-marker-alt"></i> ${property.location || 'N/A'}</p>
                        <div class="card-features">
                            ${featuresHTML || '<span>Details available</span>'}
                        </div>
                    </div>
                `;
                link.appendChild(card);
                return link;
            };

            // --- Helper Function for Currency (Ensure it's available) ---
            // Make sure formatCurrency from script.js is accessible or redefine it here
            // Example redefinition if not using global script.js:
             const formatCurrency = (amount, currency = 'NPR') => {
                 const numericAmount = Number(amount);
                 if (isNaN(numericAmount)) return `${currency} N/A`;
                 return `${currency} ${numericAmount.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
             };

            // --- Initial Load ---
            fetchAndDisplayResults();

        }); // End DOMContentLoaded
    </script>
</body>
</html>