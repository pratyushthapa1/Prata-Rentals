<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRATA - Reset Password</title>
    <link rel="stylesheet" href="globals.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/forgot-password.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
        .message-box { /* Assuming you have this for general messages */
            padding: 10px 15px; margin-bottom: 15px; border-radius: 5px;
            border: 1px solid transparent; text-align: left;
        }
        .error-message-box { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;}
    </style>
</head>
<body class="auth-page">
    <header class="main-header" style="position: static; box-shadow: none;">
         <div class="container" style="justify-content: flex-start;">
            <a href="index.html" class="header-logo">
                <img src="images/PRATA logo.png" alt="PRATA Logo">
            </a>
        </div>
    </header>

    <main class="main-content">
        <div class="auth-container reset-password-container">
            <h1>Reset Password</h1>
            <p class="sub-description">Create a new strong password for your account.</p>
            
            <div id="reset-feedback-message" class="message-box error-message-box" style="display: none;"></div>

            <form id="reset-password-form" class="auth-form">
                <!-- Hidden input to store the identifier (email or phone) -->
                <input type="hidden" id="user-identifier" name="identifier" value="">

                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new_password" placeholder="Enter new password" required minlength="8">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" placeholder="Confirm new password" required minlength="8">
                    <p id="password-match-error" class="error-message" style="display: none;">Passwords do not match.</p>
                </div>
                <div class="button-group" style="display: flex; justify-content: center; gap: 16px; margin-top:20px;">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='login.html'">Cancel</button>
                    <button type="submit" id="update-password-btn" class="btn btn-primary">Update Password</button>
                </div>
            </form>
        </div>
    </main>

     <footer class="main-footer" style="margin-top: 30px; background: transparent; border-top: none; padding-top: 0;">
         <div class="container">
             <div class="footer-copyright">
                Â© 2024 PRATA Rentals. All rights reserved.
            </div>
         </div>
     </footer>

     <script>
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const identifierFromUrl = params.get('identifier'); // Get 'identifier'
            const userIdentifierInput = document.getElementById('user-identifier');
            
            if (userIdentifierInput && identifierFromUrl) {
                userIdentifierInput.value = identifierFromUrl;
                console.log("User identifier for password reset:", identifierFromUrl);
            } else {
                console.error("Identifier missing from URL for password reset.");
                // Display error to user if identifier is crucial and missing
                const feedbackDiv = document.getElementById('reset-feedback-message');
                if (feedbackDiv) {
                    feedbackDiv.textContent = 'Invalid or missing reset link. Please start over.';
                    feedbackDiv.style.display = 'block';
                }
                const updateBtn = document.getElementById('update-password-btn');
                if(updateBtn) updateBtn.disabled = true; // Disable form submission
            }

            const resetForm = document.getElementById('reset-password-form');
            const newPassInput = document.getElementById('new-password');
            const confirmPassInput = document.getElementById('confirm-password');
            const passwordMatchError = document.getElementById('password-match-error');
            const feedbackMessageDiv = document.getElementById('reset-feedback-message'); // General feedback
            const submitBtn = document.getElementById('update-password-btn');

            if (!resetForm) {
                console.error("Reset password form not found!");
                return;
            }

            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (passwordMatchError) passwordMatchError.style.display = 'none';
                if (feedbackMessageDiv) feedbackMessageDiv.style.display = 'none';

                const userIdentifier = userIdentifierInput.value;
                const newPassword = newPassInput.value;
                const confirmPassword = confirmPassInput.value;

                if (!userIdentifier) {
                    if (feedbackMessageDiv) {
                        feedbackMessageDiv.textContent = 'User identification is missing. Cannot reset password. Please start the process again.';
                        feedbackMessageDiv.style.display = 'block';
                    }
                    return;
                }

                if (newPassword.length < 8) {
                    if (feedbackMessageDiv) {
                        feedbackMessageDiv.textContent = 'Password must be at least 8 characters long.';
                        feedbackMessageDiv.style.display = 'block';
                    }
                    newPassInput.focus();
                    return;
                }

                if (newPassword !== confirmPassword) {
                    if (passwordMatchError) passwordMatchError.style.display = 'block';
                    confirmPassInput.focus();
                    return;
                }

                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Updating...';

                try {
                    // You need a PHP script to handle this, e.g., 'php/update_password.php'
                    const response = await fetch('php/update_password.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            identifier: userIdentifier, // Send 'identifier'
                            new_password: newPassword
                            // Optionally, if you generated a secure reset token in php/verify_phone_otp.php
                            // and stored it in session, you might not need to send identifier.
                            // Instead, php/update_password.php would check the session token.
                        })
                    });
                    const data = await response.json();

                    if (response.ok && data.success) {
                        // Password reset successful
                        if (feedbackMessageDiv) {
                            feedbackMessageDiv.textContent = data.message || 'Password has been reset successfully! You can now log in.';
                            feedbackMessageDiv.classList.remove('error-message-box');
                            feedbackMessageDiv.classList.add('success-message-box'); // Assuming you have this class
                            feedbackMessageDiv.style.display = 'block';
                        }
                        resetForm.reset();
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 4000);
                    } else {
                        if (feedbackMessageDiv) {
                            feedbackMessageDiv.textContent = data.message || 'Failed to reset password. Please try again.';
                            feedbackMessageDiv.classList.add('error-message-box');
                            feedbackMessageDiv.style.display = 'block';
                        }
                    }
                } catch (err) {
                    console.error('Reset Password Error:', err);
                    if (feedbackMessageDiv) {
                        feedbackMessageDiv.textContent = 'An error occurred. Please check your connection and try again.';
                        feedbackMessageDiv.classList.add('error-message-box');
                        feedbackMessageDiv.style.display = 'block';
                    }
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });

             // Real-time password match validation
             confirmPassInput.addEventListener('input', () => {
                 if (newPassInput.value !== confirmPassInput.value) {
                     if (passwordMatchError) {
                         passwordMatchError.textContent = 'Passwords do not match.';
                         passwordMatchError.style.display = 'block';
                     }
                 } else {
                     if (passwordMatchError) passwordMatchError.style.display = 'none';
                 }
             });
             newPassInput.addEventListener('input', () => {
                 if (confirmPassInput.value && newPassInput.value !== confirmPassInput.value) {
                     if (passwordMatchError) {
                         passwordMatchError.textContent = 'Passwords do not match.';
                         passwordMatchError.style.display = 'block';
                     }
                 } else if (confirmPassInput.value) {
                     if (passwordMatchError) passwordMatchError.style.display = 'none';
                 }
             });
        });
     </script>
</body>
</html>